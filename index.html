<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOTO Mobile Pro - Full Compliance</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#b91c1c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; padding-bottom: 100px; font-family: sans-serif; }
        input, select, textarea { font-size: 16px !important; }
        .multi-device-scroll { max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 8px; background: white; }
        .sticky-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 2px solid #eee; padding: 15px; z-index: 100; display: flex; gap: 10px; }
        .validate.error-border { border: 2px solid red !important; }
    </style>
</head>
<body class="bg-slate-50">
    <div class="p-4 max-w-lg mx-auto">
        <header class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black text-red-700 uppercase">LOTO Mobile</h1>
                <p class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">OSHA Compliance Tool</p>
            </div>
            <div class="text-right">
                <p id="displayID" class="text-xs font-mono font-bold text-red-600 bg-red-50 p-2 rounded border border-red-200">ID: PENDING</p>
            </div>
        </header>

        <div class="space-y-3 bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6">
            <input type="text" id="facility" oninput="updateID()" class="w-full border p-3 rounded-lg validate" placeholder="Facility (e.g. HYD8)">
            <input type="text" id="location" oninput="updateID()" class="w-full border p-3 rounded-lg validate" placeholder="Location">
            <input type="text" id="description" oninput="updateID()" class="w-full border p-3 rounded-lg validate" placeholder="Equipment Name">
            <input type="date" id="revisedDate" class="w-full border p-3 rounded-lg validate">
        </div>

        <div id="points-list" class="space-y-6"></div>
    </div>

    <div class="sticky-bottom shadow-2xl">
        <button onclick="addNewPoint()" class="flex-1 bg-slate-800 text-white font-bold py-4 rounded-xl active:scale-95 transition">+ ADD STEP</button>
        <button onclick="validateAndGenerate()" class="flex-1 bg-red-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition">GENERATE PDF</button>
    </div>

    <script>
        let pointCounter = 0;
        const imageDataStore = {};
        let currentID = "";

        const energyConfig = {
            "Electrical":     { code: "E",  bg: [255, 0, 0],    text: [255, 255, 255] },
            "Mechanical":     { code: "M",  bg: [0, 0, 255],    text: [255, 255, 255] },
            "Compressed Air": { code: "CA", bg: [0, 255, 255],  text: [0, 0, 0] },
            "Radiation":      { code: "R",  bg: [255, 255, 0],  text: [0, 0, 0] },
            "Chemical":       { code: "C",  bg: [0, 128, 0],    text: [255, 255, 255] },
            "Hydraulic":      { code: "H",  bg: [255, 165, 0],  text: [0, 0, 0] },
            "Pneumatic":      { code: "P",  bg: [128, 0, 128],  text: [255, 255, 255] },
            "Steam":          { code: "S",  bg: [128, 128, 128],text: [255, 255, 255] },
            "Water":          { code: "W",  bg: [0, 191, 255],  text: [0, 0, 0] }
        };

        const deviceOptions = ["Circuit Breaker Lockout", "Plug Lockout", "Wall Switch Lockout", "Ball Valve Lockout", "Gate Valve Lockout", "Cable Lockout", "Pneumatic Lockout"];

        function updateID() {
            const fac = document.getElementById('facility').value.trim().toUpperCase() || "FAC";
            const loc = document.getElementById('location').value.trim().toUpperCase() || "LOC";
            const desc = document.getElementById('description').value.trim().toUpperCase() || "DESC";
            currentID = `${fac.replace(/\s+/g, '')}-${loc.replace(/\s+/g, '')}-${desc.replace(/\s+/g, '')}`;
            document.getElementById('displayID').innerText = `ID: ${currentID}`;
        }

        function handleTagAutoGeneration(id) {
            const selectedEnergy = document.getElementById(`energy-type-${id}`).value;
            if (!selectedEnergy) return;
            const prefix = energyConfig[selectedEnergy].code;
            let count = 0;
            document.querySelectorAll('[id^="energy-type-"]').forEach((el) => { if (el.value === selectedEnergy) count++; });
            document.getElementById(`tag-${id}`).value = `${prefix}-${count}`;
        }

        function addNewPoint() {
            pointCounter++;
            const id = pointCounter;
            const card = document.createElement('div');
            card.className = "bg-white p-5 rounded-xl shadow-sm border-2 border-gray-200 relative mb-4";
            card.innerHTML = `
                <div class="mb-3 flex justify-between items-center">
                    <span class="bg-red-600 text-white px-3 py-1 rounded-full text-[10px] font-bold">ISOLATION STEP ${id}</span>
                    <input type="text" id="tag-${id}" class="text-right font-mono font-bold text-red-600 bg-transparent w-20" readonly>
                </div>
                <select id="energy-type-${id}" onchange="handleTagAutoGeneration(${id})" class="w-full border p-3 rounded-lg mb-4 validate bg-gray-50">
                    <option value="">Select Energy...</option>
                    ${Object.keys(energyConfig).map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                </select>
                <div class="multi-device-scroll mb-4">${deviceOptions.map(opt => `<label class="flex items-center mb-2"><input type="checkbox" class="device-checkbox-${id} mr-2" value="${opt}"><span class="text-sm">${opt}</span></label>`).join('')}</div>
                <textarea id="isolate-${id}" class="w-full border p-3 rounded-lg text-sm mb-3 validate" rows="2" placeholder="Describe Isolation Action..."></textarea>
                <textarea id="verify-${id}" class="w-full border p-3 rounded-lg text-sm mb-4 validate" rows="2" placeholder="Describe Verification..."></textarea>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center bg-slate-50 active:bg-gray-100">
                    <label class="cursor-pointer block">
                        <span class="text-red-600 font-bold text-sm block">ðŸ“¸ TAKE PHOTO</span>
                        <input type="file" id="file-${id}" accept="image/*" capture="environment" onchange="previewFile(this, ${id})" class="hidden">
                    </label>
                    <div id="preview-box-${id}" class="mt-2 hidden"><img id="img-target-${id}" class="w-full h-48 object-cover rounded-lg shadow-inner"></div>
                </div>
            `;
            document.getElementById('points-list').appendChild(card);
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        function previewFile(input, id) {
            const file = input.files[0];
            if (file) { 
                const reader = new FileReader(); 
                reader.onload = (e) => { imageDataStore[id] = e.target.result; document.getElementById(`preview-box-${id}`).classList.remove('hidden'); document.getElementById(`img-target-${id}`).src = e.target.result; }; 
                reader.readAsDataURL(file); 
            }
        }

        function validateAndGenerate() {
            let isValid = true;
            document.querySelectorAll('.validate').forEach(el => { 
                if (!el.value.trim()) { el.classList.add('error-border'); isValid = false; } 
                else { el.classList.remove('error-border'); }
            });
            if (!isValid) { alert("Fill all fields."); return; }
            generateLotoPDF();
        }

        async function generateLotoPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const energyCounts = {};
            for (let i = 1; i <= pointCounter; i++) {
                const type = document.getElementById(`energy-type-${i}`).value;
                energyCounts[type] = (energyCounts[type] || 0) + 1;
            }
            const energySummary = Object.entries(energyCounts).map(([type, count]) => `${type}-${count.toString().padStart(2, '0')}`).join(', ');

            // Header Red Bar
            doc.setFillColor(180, 0, 0); doc.rect(0, 0, 210, 18, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(14); doc.setFont("helvetica", "bold");
            doc.text("LOCKOUT / TAGOUT POSTED PROCEDURE", 105, 12, { align: "center" });

            // ID & Info Box
            doc.setLineWidth(0.8); doc.setDrawColor(0); doc.rect(10, 22, 190, 32);
            doc.setTextColor(0,0,0); doc.setFontSize(8);
            doc.text(`ID#: ${currentID}`, 14, 28);
            doc.text(`Facility: ${document.getElementById('facility').value}`, 14, 34);
            doc.text(`Location: ${document.getElementById('location').value}`, 14, 40);
            doc.text(`Description: ${document.getElementById('description').value}`, 14, 46);
            doc.setFont("helvetica", "bold"); doc.text(`Total Energy Sources: ${pointCounter}`, 125, 28);
            const wrappedEnergy = doc.splitTextToSize(`Types: ${energySummary}`, 65);
            doc.text(wrappedEnergy, 125, 34);
            doc.setFont("helvetica", "normal"); doc.text(`Revised: ${document.getElementById('revisedDate').value}`, 125, 48);

            // COMPLIANCE SECTION: Purpose, Scope, Authorization
            let compY = 58;
            doc.rect(10, compY, 190, 80); doc.setFontSize(7.5);
            const data = [
                { t: "Purpose:", p: "This procedure establishes the minimum requirements for the lockout of energy isolating devices whenever maintenance or servicing is done on machines or equipment." },
                { t: "Scope:", p: "Ensure the equipment is stopped, isolated from all potentially hazardous energy sources and locked out before employees perform servicing or maintenance." },
                { t: "Authorization:", p: "This procedure shall only be used by employees that have been trained as 'Authorized' employees under OSHA 1910.147." },
                { t: "Application Process:", p: "1. Notify 2. Identify 3. Shutdown 4. Isolate 5. Lock/Tag 6. Release 7. Verify Isolation." }
            ];
            let tY = compY + 6;
            data.forEach(s => {
                doc.setFont("helvetica", "bold"); doc.text(s.t, 14, tY);
                doc.setFont("helvetica", "normal");
                const lines = doc.splitTextToSize(s.p, 180); doc.text(lines, 14, tY + 4);
                tY += (lines.length * 4) + 6;
            });

            // TABLE PAGE 1
            const rows = [];
            for (let i = 1; i <= pointCounter; i++) {
                const dev = Array.from(document.querySelectorAll(`.device-checkbox-${i}:checked`)).map(cb => cb.value).join(', ');
                rows.push([document.getElementById(`tag-${i}`).value, dev, document.getElementById(`isolate-${i}`).value, "", document.getElementById(`verify-${i}`).value]);
            }
            doc.autoTable({
                startY: 142, head: [['Tag', 'Devices', 'Action', 'Visual', 'Verify']], body: rows, theme: 'grid', rowPageBreak: 'avoid',
                styles: { minCellHeight: 40, verticalAlign: 'middle', fontSize: 7, lineWidth: 0.5, lineColor: [0,0,0] },
                columnStyles: { 0: { cellWidth: 15, fontStyle: 'bold' }, 1: { cellWidth: 32 }, 2: { cellWidth: 39 }, 3: { cellWidth: 58 }, 4: { cellWidth: 46 } },
                didDrawCell: (d) => { 
                    if (d.column.index === 0 && d.cell.section === 'body') {
                        const type = document.getElementById(`energy-type-${d.row.index + 1}`).value;
                        const colors = energyConfig[type];
                        if (colors) { doc.setFillColor(...colors.bg); doc.rect(d.cell.x+0.5, d.cell.y+0.5, d.cell.width-1, d.cell.height-1, 'F'); doc.setTextColor(...colors.text); doc.text(d.cell.text, d.cell.x+d.cell.width/2, d.cell.y+d.cell.height/2, { align:'center', baseline:'middle' }); }
                    }
                    if (d.column.index === 3 && d.cell.section === 'body' && imageDataStore[d.row.index + 1]) { doc.addImage(imageDataStore[d.row.index + 1], 'JPEG', d.cell.x+2, d.cell.y+2, 54, 36); } 
                }
            });

            // PAGE 2: SEQUENCES
            doc.addPage();
            doc.setFillColor(180, 0, 0); doc.rect(0, 0, 210, 18, 'F');
            doc.setTextColor(255, 255, 255); doc.text("SAFETY SEQUENCES", 105, 12, { align: "center" });
            doc.autoTable({
                startY: 25, head: [['#', 'SHUTDOWN SEQUENCE', 'DESCRIPTION']],
                body: [['1','Notify','Inform all affected employees.'],['2','Review','Check LOTO requirements.'],['3','Stop','Standard shutdown.'],['4','Isolate','Operate disconnects.'],['5','Lockout','Apply locks/tags.'],['6','Release','Dissipate stored energy.'],['7','Verify','Test start then OFF.']],
                theme:'grid', styles:{fontSize:8.5}, headStyles:{fillColor:[180,0,0]}
            });
            doc.autoTable({
                startY: doc.lastAutoTable.finalY+10, head: [['#', 'RESTORATION SEQUENCE', 'DESCRIPTION']],
                body: [['1','Check','Remove tools/parts.'],['2','Area','Clear all personnel.'],['3','Verify','Controls in neutral.'],['4','Restore','Remove locks.'],['5','Notify','Inform work is done.']],
                theme:'grid', styles:{fontSize:8.5}, headStyles:{fillColor:[0,80,150]}
            });

            // PAGE 3: TAGS
            doc.addPage();
            doc.setFillColor(50, 50, 50); doc.rect(0, 0, 210, 18, 'F');
            doc.setTextColor(255, 255, 255); doc.text("POINT TAGS (1\" x 2\")", 105, 12, { align: "center" });
            const tagW = 50.8, tagH = 25.4; let cx = 10, cy = 25;
            for (let i = 1; i <= pointCounter; i++) {
                const colors = energyConfig[document.getElementById(`energy-type-${i}`).value] || {bg:[255,255,255],text:[0,0,0]};
                doc.setFillColor(...colors.bg); doc.rect(cx, cy, tagW, tagH, 'F');
                doc.setDrawColor(0); doc.rect(cx, cy, tagW, tagH, 'D');
                doc.setTextColor(...colors.text); doc.setFontSize(18); doc.text(document.getElementById(`tag-${i}`).value, cx+4, cy+12);
                cx += tagW + 2; if (cx + tagW > 200) { cx = 10; cy += tagH + 2; }
            }
            doc.save(`${currentID}.pdf`);
        }
    </script>
</body>
</html>
