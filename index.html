<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOTO Pro - Industrial Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; padding-bottom: 120px; }
        .label-style { font-size: 11px; font-weight: 800; color: #1e293b; text-transform: uppercase; margin-bottom: 6px; display: block; }
        .step-card { border-left-width: 8px; border-radius: 16px; border-color: #e2e8f0; transition: all 0.3s ease; }
        .validate.error-border { border: 2.5px solid #ef4444 !important; background-color: #fff1f1; }
    </style>
</head>
<body>
    <div class="sticky top-0 bg-white/95 backdrop-blur-md p-4 mb-6 shadow-sm z-50 border-b">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black text-slate-900 italic">LOTO<span class="text-red-600">PRO</span></h1>
            </div>
            <div class="text-right">
                <button onclick="resetApp()" class="text-[10px] font-bold text-slate-400 uppercase hover:text-red-600">Reset</button>
                <p id="displayID" class="text-xs font-mono font-bold text-red-600">PENDING</p>
            </div>
        </div>
    </div>

    <div class="p-4 max-w-lg mx-auto">
        <div class="bg-white p-6 rounded-2xl shadow-md border border-slate-200 mb-8 space-y-4">
            <div><label class="label-style">Facility Name</label><input type="text" id="facility" oninput="updateID()" class="w-full border-slate-300 border-2 p-3 rounded-xl validate" placeholder="FACTORY-NORTH"></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="label-style">Location</label><input type="text" id="location" oninput="updateID()" class="w-full border-slate-300 border-2 p-3 rounded-xl validate" placeholder="SUB-01"></div>
                <div><label class="label-style">Date</label><input type="date" id="revisedDate" class="w-full border-slate-300 border-2 p-3 rounded-xl validate"></div>
            </div>
            <div><label class="label-style">Equipment Name</label><input type="text" id="description" oninput="updateID()" class="w-full border-slate-300 border-2 p-3 rounded-xl validate" placeholder="MAIN BOILER PUMP"></div>
        </div>
        <div id="points-list" class="space-y-6"></div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-md flex gap-4 z-[1000] border-t">
        <button onclick="addNewPoint()" class="flex-1 bg-slate-900 text-white font-black py-4 rounded-2xl shadow-xl">+ ADD STEP</button>
        <button onclick="validateAndGenerate()" class="flex-1 bg-red-600 text-white font-black py-4 rounded-2xl shadow-xl italic">GENERATE PDF</button>
    </div>

    <script>
        let uniqueIdCounter = 0;
        let imageDataStore = {}; 
        let currentID = "";

        const energyConfig = {
            "Electrical": { code: "E", bg: [185, 28, 28], text: [255, 255, 255] },
            "Mechanical": { code: "M", bg: [30, 64, 175], text: [255, 255, 255] },
            "Compressed Air": { code: "CA", bg: [8, 145, 178], text: [255, 255, 255] },
            "Hydraulic": { code: "H", bg: [194, 65, 12], text: [255, 255, 255] },
            "Chemical": { code: "C", bg: [21, 128, 61], text: [255, 255, 255] }
        };

        function resetApp() {
            if(confirm('Clear all data and photos?')) {
                document.getElementById('points-list').innerHTML = '';
                document.querySelectorAll('.validate').forEach(i => i.value = '');
                imageDataStore = {};
                uniqueIdCounter = 0;
                updateID();
                addNewPoint();
            }
        }

        function updateID() {
            const fac = document.getElementById('facility').value.trim().toUpperCase() || "FAC";
            const loc = document.getElementById('location').value.trim().toUpperCase() || "LOC";
            const desc = document.getElementById('description').value.trim().toUpperCase() || "DESC";
            currentID = `${fac.replace(/\s+/g, '')}-${loc.replace(/\s+/g, '')}-${desc.substring(0,8).replace(/\s+/g, '')}`;
            document.getElementById('displayID').innerText = currentID;
        }

        function reindexAllSteps() {
            const steps = document.querySelectorAll('.step-card');
            const typeCounts = {};
            steps.forEach((card, index) => {
                const id = card.dataset.internalId;
                const type = document.getElementById(`energy-type-${id}`).value;
                if (type) {
                    const code = energyConfig[type].code;
                    typeCounts[code] = (typeCounts[code] || 0) + 1;
                    document.getElementById(`tag-${id}`).value = `${code}-${typeCounts[code]}`;
                    card.style.borderLeftColor = `rgb(${energyConfig[type].bg.join(',')})`;
                }
            });
        }

        function addNewPoint() {
            uniqueIdCounter++;
            const id = uniqueIdCounter;
            const card = document.createElement('div');
            card.id = `step-container-${id}`;
            card.dataset.internalId = id;
            card.className = "step-card bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-4";
            card.innerHTML = `
                <div class="mb-4 flex justify-between items-center border-b pb-3">
                    <span class="point-num-label text-slate-800 font-black text-sm italic">STEP #${id}</span>
                    <input type="text" id="tag-${id}" class="text-right font-mono font-bold text-red-600 bg-red-50 p-1 w-16 rounded border-none" readonly>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="label-style">Energy Source</label>
                        <select id="energy-type-${id}" onchange="reindexAllSteps()" class="w-full border-2 p-3 rounded-xl validate outline-none">
                            <option value="">-- Select --</option>${Object.keys(energyConfig).map(k => `<option value="${k}">${k}</option>`).join('')}
                        </select>
                    </div>
                    <div><label class="label-style">Isolation Method</label><textarea id="isolate-${id}" class="w-full border-2 p-3 rounded-xl text-sm validate outline-none" rows="2"></textarea></div>
                    <div><label class="label-style">Verification</label><textarea id="verify-${id}" class="w-full border-2 p-3 rounded-xl text-sm validate outline-none" rows="2"></textarea></div>
                    <div class="border-2 border-dashed border-slate-200 rounded-2xl p-4 text-center cursor-pointer bg-slate-50" onclick="document.getElementById('file-${id}').click()">
                        <p class="text-red-600 font-black text-xs">ðŸ“¸ CAPTURE PHOTO</p>
                        <input type="file" id="file-${id}" accept="image/*" capture="environment" onchange="previewFile(this, ${id})" class="hidden">
                        <div id="preview-box-${id}" class="mt-2 hidden"><img id="img-target-${id}" class="w-full h-32 object-cover rounded-lg shadow-sm"></div>
                    </div>
                </div>`;
            document.getElementById('points-list').appendChild(card);
            reindexAllSteps();
        }

        function previewFile(input, id) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageDataStore[id] = e.target.result;
                    document.getElementById(`preview-box-${id}`).classList.remove('hidden');
                    document.getElementById(`img-target-${id}`).src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function validateAndGenerate() {
            let ok = true;
            document.querySelectorAll('.validate').forEach(el => {
                if (!el.value.trim()) { el.classList.add('error-border'); ok = false; }
                else { el.classList.remove('error-border'); }
            });
            if (ok) generatePDF();
            else alert("Please fill all required fields.");
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const equip = document.getElementById('description').value;
            const loc = document.getElementById('location').value;
            const steps = document.querySelectorAll('.step-card');
            const qrData = new QRious({ value: currentID, size: 300 }).toDataURL();

            // Analytics logic for Section 1
            const energyCounts = {};
            steps.forEach(card => {
                const id = card.dataset.internalId;
                const type = document.getElementById(`energy-type-${id}`).value;
                if (type) energyCounts[type] = (energyCounts[type] || 0) + 1;
            });
            const summaryString = Object.entries(energyCounts).map(([k,v]) => `${k}(${v})`).join(', ');

            // PAGE 1: HEADER & TABLE
            doc.setFillColor(30, 41, 59); doc.rect(0, 0, 210, 22, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(16); doc.text("LOTO POSTED PROCEDURE", 10, 14);

            doc.setFillColor(248, 250, 252); doc.rect(10, 28, 190, 40, 'FD'); 
            doc.setTextColor(30, 41, 59); doc.setFontSize(9);
            doc.text(`ID: ${currentID}`, 14, 36);
            doc.text(`EQUIPMENT: ${equip}`, 14, 43);
            doc.text(`LOCATION: ${loc}`, 14, 50);
            
            // Energy Source Data in Section 1
            doc.setFont("helvetica", "bold");
            doc.text(`TOTAL SOURCES: ${steps.length}`, 115, 36);
            doc.setFont("helvetica", "normal");
            const wrapSummary = doc.splitTextToSize(`ENERGY TYPES: ${summaryString}`, 60);
            doc.text(wrapSummary, 115, 43);
            
            doc.addImage(qrData, 'PNG', 170, 32, 25, 25);

            const tableRows = [];
            steps.forEach(card => {
                const id = card.dataset.internalId;
                tableRows.push([document.getElementById(`tag-${id}`).value, document.getElementById(`isolate-${id}`).value, "", document.getElementById(`verify-${id}`).value, id]);
            });

            doc.autoTable({
                startY: 75,
                head: [['TAG', 'ISOLATION METHOD', 'VISUAL', 'VERIFICATION']],
                body: tableRows.map(r => r.slice(0, 4)),
                styles: { fontSize: 7, minCellHeight: 40, verticalAlign: 'middle' },
                columnStyles: { 0: {cellWidth: 15}, 2: {cellWidth: 50} },
                didDrawCell: (d) => {
                    if (d.column.index === 2 && d.cell.section === 'body') {
                        const sid = tableRows[d.row.index][4];
                        if (imageDataStore[sid]) doc.addImage(imageDataStore[sid], 'JPEG', d.cell.x+2, d.cell.y+2, 46, 36);
                    }
                }
            });

            // PAGE 2: SEQUENCES
            doc.addPage();
            doc.setFillColor(30, 41, 59); doc.rect(0, 0, 210, 15, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(12); doc.text("SHUTDOWN, LOCK, TAG & TEST SEQUENCE", 105, 10, { align: "center" });

            doc.autoTable({
                startY: 20,
                head: [['#', 'STEP', 'DESCRIPTION']],
                body: [
                    ['1', 'Notify Employees', 'Notify all affected employees that servicing or maintenance is required...'],
                    ['2', 'Review Procedure', 'Authorized employee shall refer to company procedure to identify hazards...'],
                    ['3', 'Machine Stop', 'Shut it down by normal stopping procedure (stop button, switch, etc.)...'],
                    ['4', 'Isolate Energy', 'Follow graphical procedure to de-activate energy isolating device(s)...'],
                    ['5', 'Lockout Energy', 'Lock out & tag out the energy isolating device(s) with individual locks...'],
                    ['6', 'Dissipate Energy', 'Residual energy (capacitors, springs, pressure) must be dissipated or restrained...'],
                    ['7', 'Attempt Restart', 'Verify isolation by operating push button or controls.']
                ],
                headStyles: { fillColor: [185, 28, 28] }, styles: { fontSize: 8 }
            });

            doc.setFillColor(30, 41, 59); doc.rect(0, doc.lastAutoTable.finalY + 10, 210, 15, 'F');
            doc.setTextColor(255, 255, 255); doc.text("RESTORE TO SERVICE SEQUENCE", 105, doc.lastAutoTable.finalY + 20, { align: "center" });

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 25,
                head: [['#', 'STEP', 'DESCRIPTION']],
                body: [
                    ['1', 'Check Machine', 'Ensure nonessential items have been removed and components are intact...'],
                    ['2', 'Check Area', 'Ensure all employees have been safely positioned or removed from the area...'],
                    ['3', 'Verify Machine', 'Verify that the controls are in neutral.'],
                    ['4', 'Remove Lockout', 'Remove locks, tags and devices. Re-energize in reverse order...'],
                    ['5', 'Notify Employees', 'Notify affected employees that servicing is completed.']
                ],
                headStyles: { fillColor: [30, 64, 175] }, styles: { fontSize: 8 }
            });

            // PAGE 3: TAGS
            doc.addPage();
            let cx = 15, cy = 30;
            tableRows.forEach((row) => {
                const sid = row[4];
                const tagNum = row[0];
                const type = document.getElementById(`energy-type-${sid}`).value;
                const config = energyConfig[type] || {bg: [200, 200, 200], text: [0, 0, 0]};

                doc.setDrawColor(0); doc.setFillColor(255, 255, 255); doc.rect(cx, cy, 60, 35, 'FD');
                doc.setFillColor(...config.bg); doc.rect(cx, cy, 35, 12, 'F');
                doc.setTextColor(...config.text); doc.setFontSize(14); doc.setFont("helvetica", "bold");
                doc.text(tagNum, cx + 17.5, cy + 8.5, { align: 'center' });

                doc.setTextColor(30, 41, 59); doc.setFontSize(7);
                doc.text(`EQ: ${equip.substring(0, 22)}`, cx + 2, cy + 18);
                doc.text(`LOC: ${loc.substring(0, 22)}`, cx + 2, cy + 24);
                doc.addImage(qrData, 'PNG', cx + 38, cy + 4, 18, 18);

                cx += 65;
                if (cx > 160) { cx = 15; cy += 45; }
                if (cy > 240) { doc.addPage(); cx = 15; cy = 30; }
            });

            doc.save(`${currentID}_LOTO.pdf`);
        }
        window.onload = () => { updateID(); addNewPoint(); };
    </script>
</body>
</html>
