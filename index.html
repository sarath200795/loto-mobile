<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOTO Mobile Pro - Full Hardware & Reset</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#b91c1c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; padding-bottom: 120px; font-family: sans-serif; }
        input, select, textarea { font-size: 16px !important; }
        .label-style { font-size: 11px; font-weight: 800; color: #475569; text-transform: uppercase; margin-bottom: 6px; display: block; }
        /* Professional scroll box for hardware list */
        .multi-device-scroll { 
            max-height: 200px; 
            overflow-y: auto; 
            border: 2px solid #e2e8f0; 
            padding: 12px; 
            border-radius: 8px; 
            background: #f8fafc;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .sticky-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 2px solid #eee; padding: 15px; z-index: 100; display: flex; gap: 10px; }
        .validate.error-border { border: 2px solid #ef4444 !important; }
        .btn-reset { background: #f1f5f9; color: #64748b; font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 6px; border: 1px solid #cbd5e1; text-transform: uppercase; }
    </style>
</head>
<body class="bg-slate-50">
    <div class="p-4 max-w-lg mx-auto">
        <header class="mb-6 flex justify-between items-start border-b pb-4">
            <div>
                <h1 class="text-2xl font-black text-red-700 uppercase">LOTO Mobile</h1>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Compliance Management</p>
                <button onclick="resetApp()" class="btn-reset mt-2">Clear All Fields</button>
            </div>
            <div class="text-right">
                <p id="displayID" class="text-xs font-mono font-bold text-red-600 bg-red-50 p-2 rounded border border-red-200">ID: PENDING</p>
            </div>
        </header>

        <div class="space-y-4 bg-white p-5 rounded-xl shadow-sm border border-slate-200 mb-6">
            <div><label class="label-style">Facility Name</label><input type="text" id="facility" oninput="updateID()" class="w-full border p-3 rounded-lg validate" placeholder="e.g. SITE-01"></div>
            <div><label class="label-style">Location</label><input type="text" id="location" oninput="updateID()" class="w-full border p-3 rounded-lg validate" placeholder="e.g. ELECTRICAL ROOM"></div>
            <div><label class="label-style">Equipment</label><input type="text" id="description" oninput="updateID()" class="w-full border p-3 rounded-lg validate" placeholder="e.g. MAIN COMPRESSOR"></div>
            <div><label class="label-style">Revision Date</label><input type="date" id="revisedDate" class="w-full border p-3 rounded-lg validate"></div>
        </div>

        <div id="points-list" class="space-y-6"></div>
    </div>

    <div class="sticky-bottom shadow-2xl">
        <button onclick="addNewPoint()" class="flex-1 bg-slate-800 text-white font-bold py-4 rounded-xl active:scale-95 transition">+ ADD STEP</button>
        <button onclick="validateAndGenerate()" class="flex-1 bg-red-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition">GENERATE PDF</button>
    </div>

    <script>
        let pointCounter = 0;
        let imageDataStore = {};
        let currentID = "";

        const energyConfig = {
            "Electrical":     { code: "E",  bg: [220, 38, 38],   text: [255, 255, 255] },
            "Mechanical":     { code: "M",  bg: [37, 99, 235],   text: [255, 255, 255] },
            "Compressed Air": { code: "CA", bg: [6, 182, 212],   text: [0, 0, 0] },
            "Radiation":      { code: "R",  bg: [234, 179, 8],   text: [0, 0, 0] },
            "Chemical":       { code: "C",  bg: [22, 163, 74],   text: [255, 255, 255] },
            "Hydraulic":      { code: "H",  bg: [249, 115, 22],  text: [255, 255, 255] },
            "Pneumatic":      { code: "P",  bg: [147, 51, 234],  text: [255, 255, 255] },
            "Steam":          { code: "S",  bg: [71, 85, 105],   text: [255, 255, 255] },
            "Water":          { code: "W",  bg: [14, 165, 233],  text: [0, 0, 0] }
        };

        // FULL COMPREHENSIVE HARDWARE LIST
        const deviceOptions = [
            "Safety Padlock (Assigned)", "Lockout Hasp (Steel)", "Circuit Breaker (Single)", 
            "Circuit Breaker (Multi-pole)", "Large Breaker Lockout", "Wall Switch Lockout", 
            "Electrical Plug Lockout", "Ball Valve Lockout (S)", "Ball Valve Lockout (L)", 
            "Gate Valve Lockout (Rotating)", "Butterfly Valve Lockout", "Plug Valve Lockout", 
            "Cable Lockout Device", "Pneumatic Quick-Disconnect", "Cylinder Tank Lockout", 
            "Push Button Cover", "Group Lockout Box", "Blind Flange Lockout"
        ];

        function updateID() {
            const fac = document.getElementById('facility').value.trim().toUpperCase() || "FAC";
            const loc = document.getElementById('location').value.trim().toUpperCase() || "LOC";
            const desc = document.getElementById('description').value.trim().toUpperCase() || "DESC";
            currentID = `${fac.replace(/\s+/g, '')}-${loc.replace(/\s+/g, '')}-${desc.substring(0,8).replace(/\s+/g, '')}`;
            document.getElementById('displayID').innerText = `ID: ${currentID}`;
        }

        function handleTagAutoGeneration(id) {
            const val = document.getElementById(`energy-type-${id}`).value;
            if (!val) return;
            const prefix = energyConfig[val].code;
            let count = 0;
            document.querySelectorAll('[id^="energy-type-"]').forEach(el => { if (el.value === val) count++; });
            document.getElementById(`tag-${id}`).value = `${prefix}-${count}`;
        }

        function addNewPoint() {
            pointCounter++;
            const id = pointCounter;
            const container = document.getElementById('points-list');
            const card = document.createElement('div');
            card.id = `step-container-${id}`;
            card.className = "bg-white p-5 rounded-xl shadow-md border-2 border-slate-200 mb-4";
            
            card.innerHTML = `
                <div class="mb-4 flex justify-between items-center border-b pb-2">
                    <span class="text-red-700 font-black text-sm">POINT #${id}</span>
                    <div class="flex items-center gap-3">
                        <input type="text" id="tag-${id}" class="text-right font-mono font-bold text-red-600 bg-transparent w-16" readonly>
                        <button onclick="deleteStep(${id})" class="text-gray-300">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                </div>
                <label class="label-style">Energy Type</label>
                <select id="energy-type-${id}" onchange="handleTagAutoGeneration(${id})" class="w-full border p-3 rounded-lg mb-4 validate bg-slate-50">
                    <option value="">-- Choose Energy --</option>
                    ${Object.keys(energyConfig).map(k => `<option value="${k}">${k}</option>`).join('')}
                </select>
                <label class="label-style">Hardware Checklist</label>
                <div class="multi-device-scroll mb-4">${deviceOptions.map(o => `<label class="flex items-center mb-3"><input type="checkbox" class="device-checkbox-${id} w-5 h-5 text-red-600" value="${o}"><span class="ml-3 text-sm">${o}</span></label>`).join('')}</div>
                <label class="label-style">Isolation Step</label>
                <textarea id="isolate-${id}" class="w-full border p-3 rounded-lg text-sm mb-4 validate" rows="2" placeholder="Action..."></textarea>
                <label class="label-style">Verification</label>
                <textarea id="verify-${id}" class="w-full border p-3 rounded-lg text-sm mb-4 validate" rows="2" placeholder="How to verify zero energy..."></textarea>
                <div class="border-2 border-dashed border-slate-300 rounded-lg p-4 text-center bg-slate-50">
                    <label class="cursor-pointer block">
                        <span class="text-red-600 font-bold text-sm block">ðŸ“¸ TAKE PHOTO</span>
                        <input type="file" id="file-${id}" accept="image/*" capture="environment" onchange="previewFile(this, ${id})" class="hidden">
                    </label>
                    <div id="preview-box-${id}" class="mt-2 hidden"><img id="img-target-${id}" class="w-full h-48 object-cover rounded-lg"></div>
                </div>`;
            container.appendChild(card);
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        function deleteStep(id) {
            if (confirm("Delete this point?")) {
                document.getElementById(`step-container-${id}`).remove();
                delete imageDataStore[id];
            }
        }

        function previewFile(input, id) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageDataStore[id] = e.target.result;
                    document.getElementById(`preview-box-${id}`).classList.remove('hidden');
                    document.getElementById(`img-target-${id}`).src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function resetApp() {
            if (confirm("Are you sure you want to clear all fields? All progress will be lost.")) {
                document.querySelectorAll('input, select, textarea').forEach(el => el.value = "");
                document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
                document.getElementById('points-list').innerHTML = "";
                pointCounter = 0;
                imageDataStore = {};
                updateID();
                addNewPoint();
            }
        }

        function validateAndGenerate() {
            let ok = true;
            document.querySelectorAll('.validate').forEach(el => {
                if (!el.value.trim()) { el.classList.add('error-border'); ok = false; }
                else { el.classList.remove('error-border'); }
            });
            if (!ok) return alert("Fill all mandatory fields.");
            generatePDF();
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const equip = document.getElementById('description').value;

            // DYNAMIC ENERGY SUMMARY
            const energyCounts = {};
            const activeStepIds = Array.from(document.querySelectorAll('[id^="step-container-"]')).map(el => el.id.split('-').pop());
            activeStepIds.forEach(id => {
                const type = document.getElementById(`energy-type-${id}`).value;
                if (type) energyCounts[type] = (energyCounts[type] || 0) + 1;
            });
            const summaryString = Object.entries(energyCounts).map(([t, c]) => `${t}-${c.toString().padStart(2, '0')}`).join(', ');

            // PAGE 1: HEADER
            doc.setFillColor(180, 0, 0); doc.rect(0, 0, 210, 18, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(14); doc.setFont("helvetica", "bold");
            doc.text("LOCKOUT / TAGOUT POSTED PROCEDURE", 105, 12, { align: "center" });

            doc.setDrawColor(0); doc.setLineWidth(0.8); doc.rect(10, 22, 190, 32);
            doc.setTextColor(0); doc.setFontSize(8);
            doc.text(`ID#: ${currentID}`, 14, 28);
            doc.text(`Facility: ${document.getElementById('facility').value}`, 14, 34);
            doc.text(`Location: ${document.getElementById('location').value}`, 14, 40);
            doc.text(`Equipment: ${equip}`, 14, 46);
            doc.setFont("helvetica", "bold"); doc.text(`Total Sources: ${activeStepIds.length}`, 135, 28);
            const wrappedEnergy = doc.splitTextToSize(`Types: ${summaryString}`, 60);
            doc.text(wrappedEnergy, 135, 34);

            // COMPLIANCE SECTION
            let compY = 58; doc.rect(10, compY, 190, 80);
            const comp = [
                {t: "Purpose:", p: "Establish requirements for isolation of hazardous energy during maintenance."},
                {t: "Scope:", p: "Ensure machines are safe from energy before servicing per OSHA 1910.147."},
                {t: "Authorization:", p: "Only employees trained as 'Authorized' may use this procedure."},
                {t: "Process:", p: "1. Notify 2. Identify 3. Shutdown 4. Isolate 5. Lock/Tag 6. Release 7. Verify."}
            ];
            let ty = compY + 6;
            comp.forEach(s => {
                doc.setFontSize(8); doc.setFont("helvetica", "bold"); doc.text(s.t, 14, ty);
                doc.setFont("helvetica", "normal"); doc.setFontSize(7.5);
                const lines = doc.splitTextToSize(s.p, 175); doc.text(lines, 14, ty + 4);
                ty += (lines.length * 4) + 6;
            });

            const body = [];
            activeStepIds.forEach(id => {
                const devs = Array.from(document.querySelectorAll(`.device-checkbox-${id}:checked`)).map(c => c.value).join(', ');
                body.push([document.getElementById(`tag-${id}`).value, devs, document.getElementById(`isolate-${id}`).value, "", document.getElementById(`verify-${id}`).value]);
            });

            doc.autoTable({
                startY: 142, head: [['Tag', 'Hardware', 'Method', 'Visual', 'Verify']], body: body, theme: 'grid',
                rowPageBreak: 'avoid', styles: { fontSize: 7, minCellHeight: 40, verticalAlign: 'middle' },
                columnStyles: { 0: {cellWidth: 15}, 1: {cellWidth: 32}, 3: {cellWidth: 55} },
                didDrawCell: (d) => {
                    if (d.column.index === 0 && d.cell.section === 'body') {
                        const stepId = activeStepIds[d.row.index];
                        const colors = energyConfig[document.getElementById(`energy-type-${stepId}`).value];
                        if(colors) { doc.setFillColor(...colors.bg); doc.rect(d.cell.x+0.5, d.cell.y+0.5, d.cell.width-1, d.cell.height-1, 'F'); doc.setTextColor(...colors.text); doc.text(d.cell.text, d.cell.x+d.cell.width/2, d.cell.y+d.cell.height/2, {align:'center', baseline:'middle'}); }
                    }
                    if (d.column.index === 3 && d.cell.section === 'body' && imageDataStore[activeStepIds[d.row.index]]) {
                        doc.addImage(imageDataStore[activeStepIds[d.row.index]], 'JPEG', d.cell.x+2, d.cell.y+2, 51, 36);
                    }
                }
            });

            // PAGE 2: SEQUENCES
            doc.addPage();
            doc.setFillColor(180, 0, 0); doc.rect(0, 0, 210, 18, 'F');
            doc.setTextColor(255, 255, 255); doc.text("SHUTDOWN & RESTORATION SEQUENCES", 105, 12, { align: "center" });
            doc.autoTable({
                startY: 25, head: [['#','SHUTDOWN SEQUENCE','DESCRIPTION']],
                body: [['1','Notify','Inform all affected associates.'],['2','Identify','Check all energy sources.'],['3','Stop','Standard stopping procedure.'],['4','Isolate','Operate disconnects/valves.'],['5','Lockout','Apply individual locks.'],['6','Release','Dissipate stored energy.'],['7','Verify','Attempt restart then verify zero state.']],
                theme:'grid', headStyles:{fillColor:[180,0,0]}
            });
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 10, head: [['#','RESTORATION SEQUENCE','DESCRIPTION']],
                body: [['1','Inspect','Remove tools and parts.'],['2','Clear','Ensure personnel are clear.'],['3','Verify','Controls in neutral/OFF.'],['4','Unlock','Remove all locks and tags.'],['5','Notify','Inform work is complete.']],
                theme:'grid', headStyles:{fillColor:[0,80,150]}
            });

            // PAGE 3: TAGS
            doc.addPage();
            doc.setFillColor(50, 50, 50); doc.rect(0, 0, 210, 18, 'F');
            doc.setTextColor(255, 255, 255); doc.text("ISOLATION TAGS (1\" x 2\")", 105, 12, { align: "center" });
            let cx = 10, cy = 25;
            activeStepIds.forEach(id => {
                const colors = energyConfig[document.getElementById(`energy-type-${id}`).value] || {bg:[255,255,255], text:[0,0,0]};
                doc.setFillColor(...colors.bg); doc.rect(cx, cy, 50.8, 25.4, 'F');
                doc.setDrawColor(0); doc.rect(cx, cy, 50.8, 25.4, 'D');
                doc.setTextColor(...colors.text); doc.setFontSize(16); doc.text(document.getElementById(`tag-${id}`).value, cx+4, cy+10);
                doc.setFontSize(5); doc.text(`DOC: ${currentID}`, cx+4, cy+18);
                doc.text(`EQUIP: ${equip.substring(0,25)}`, cx+4, cy+22);
                cx += 53; if (cx > 160) { cx = 10; cy += 28; }
            });
            doc.save(`${currentID}.pdf`);
        }
        window.onload = () => { updateID(); addNewPoint(); };
    </script>
</body>
</html>
