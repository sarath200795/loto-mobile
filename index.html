<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOTO Pro - Industrial Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; padding-bottom: 140px; background-color: #f8fafc; }
        .label-style { font-size: 11px; font-weight: 800; color: #1e293b; text-transform: uppercase; margin-bottom: 6px; display: block; }
        .step-card { border-left-width: 8px; border-radius: 16px; transition: all 0.3s ease; }
        .validate.error-border { border: 2.5px solid #ef4444 !important; background-color: #fff1f1; }
    </style>
</head>
<body>
    <div class="sticky top-0 bg-white/95 backdrop-blur-md p-4 mb-6 shadow-sm z-50 border-b">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black text-slate-900 italic">LOTO<span class="text-red-600">PRO</span></h1>
            </div>
            <div class="text-right">
                <button onclick="resetApplication()" class="text-[10px] font-bold text-slate-400 uppercase hover:text-red-600">Reset All</button>
                <p id="displayID" class="text-xs font-mono font-bold text-red-600">PENDING</p>
            </div>
        </div>
    </div>

    <div class="p-4 max-w-lg mx-auto">
        <div class="bg-white p-6 rounded-2xl shadow-md border border-slate-200 mb-8 space-y-4">
            <div><label class="label-style">Facility</label><input type="text" id="facility" oninput="updateID()" class="w-full border-slate-300 border-2 p-3 rounded-xl validate" placeholder="Plant Name"></div>
            <div><label class="label-style">Equipment</label><input type="text" id="description" oninput="updateID()" class="w-full border-slate-300 border-2 p-3 rounded-xl validate" placeholder="Machine Name"></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="label-style">Location</label><input type="text" id="location" oninput="updateID()" class="w-full border-slate-300 border-2 p-3 rounded-xl validate" placeholder="Section"></div>
                <div><label class="label-style">Date</label><input type="date" id="revisedDate" class="w-full border-slate-300 border-2 p-3 rounded-xl validate"></div>
            </div>
        </div>

        <div id="points-list" class="space-y-6"></div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white p-4 flex gap-4 shadow-[0_-10px_20px_rgba(0,0,0,0.05)]">
        <button onclick="addNewPoint()" class="flex-1 bg-slate-900 text-white font-black py-4 rounded-2xl">+ ADD STEP</button>
        <button onclick="validateAndGenerate()" class="flex-1 bg-red-600 text-white font-black py-4 rounded-2xl italic">GENERATE PDF</button>
    </div>

    <script>
        let uniqueIdCounter = 0;
        let imageDataStore = new Map(); // Using Map for better memory management of photos
        let currentID = "";

        const energyConfig = {
            "Electrical": { code: "E", bg: [185, 28, 28], text: [255, 255, 255] },
            "Mechanical": { code: "M", bg: [30, 64, 175], text: [255, 255, 255] },
            "Compressed Air": { code: "CA", bg: [8, 145, 178], text: [255, 255, 255] }
        };

        function resetApplication() {
            if(confirm("This will delete all progress and photos. Continue?")) {
                imageDataStore.clear();
                document.getElementById('points-list').innerHTML = '';
                document.querySelectorAll('input').forEach(i => i.value = '');
                uniqueIdCounter = 0;
                updateID();
                addNewPoint();
            }
        }

        function updateID() {
            const fac = document.getElementById('facility').value.trim().toUpperCase() || "FAC";
            const desc = document.getElementById('description').value.trim().toUpperCase().substring(0,5) || "EQ";
            currentID = `${fac}-${desc}-${new Date().getTime().toString().slice(-4)}`;
            document.getElementById('displayID').innerText = currentID;
        }

        function handleImageUpload(input, id) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64String = e.target.result;
                    // Store in memory Map
                    imageDataStore.set(id.toString(), base64String);
                    
                    // Show Preview
                    const previewContainer = document.getElementById(`preview-box-${id}`);
                    const imgElement = document.getElementById(`img-target-${id}`);
                    imgElement.src = base64String;
                    previewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function addNewPoint() {
            uniqueIdCounter++;
            const id = uniqueIdCounter;
            const card = document.createElement('div');
            card.className = "step-card bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-4";
            card.dataset.internalId = id;
            card.innerHTML = `
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <span class="font-black text-slate-800 italic">STEP #${id}</span>
                    <button onclick="this.closest('.step-card').remove()" class="text-slate-300 hover:text-red-500 font-bold">REMOVE</button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="label-style">Energy Source</label>
                        <select id="energy-${id}" class="w-full border-2 p-3 rounded-xl validate">
                            <option value="">-- Select --</option>
                            ${Object.keys(energyConfig).map(k => `<option value="${k}">${k}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="label-style">Isolation Method</label>
                        <textarea id="method-${id}" class="w-full border-2 p-3 rounded-xl validate" rows="2" placeholder="e.g. Turn off breaker #12"></textarea>
                    </div>
                    
                    <div class="border-2 border-dashed border-slate-200 rounded-2xl p-6 text-center bg-slate-50 cursor-pointer hover:bg-slate-100 transition" 
                         onclick="document.getElementById('file-input-${id}').click()">
                        <p class="text-red-600 font-black text-xs uppercase">ðŸ“¸ CAPTURE PHOTO</p>
                        <input type="file" id="file-input-${id}" accept="image/*" capture="environment" class="hidden" 
                               onchange="handleImageUpload(this, ${id})">
                        
                        <div id="preview-box-${id}" class="mt-4 hidden border-4 border-white shadow-lg rounded-lg overflow-hidden">
                            <img id="img-target-${id}" class="w-full h-48 object-cover">
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('points-list').appendChild(card);
        }

        function validateAndGenerate() {
            let isValid = true;
            document.querySelectorAll('.validate').forEach(el => {
                if (!el.value.trim()) { el.classList.add('error-border'); isValid = false; }
                else { el.classList.remove('error-border'); }
            });

            if (isValid) {
                generatePDF();
            } else {
                alert("Please fill in all required fields.");
            }
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const steps = document.querySelectorAll('.step-card');
            
            doc.setFontSize(18);
            doc.text("LOTO SAFETY PROCEDURE", 10, 20);
            doc.setFontSize(10);
            doc.text(`ID: ${currentID} | Equipment: ${document.getElementById('description').value}`, 10, 28);

            const tableRows = [];
            steps.forEach(card => {
                const id = card.dataset.internalId;
                const energy = document.getElementById(`energy-${id}`).value;
                const method = document.getElementById(`method-${id}`).value;
                tableRows.push([energy, method, "", id]); // Empty string is placeholder for image
            });

            doc.autoTable({
                startY: 35,
                head: [['Energy Source', 'Isolation Method', 'Visual Reference']],
                body: tableRows.map(r => [r[0], r[1], ""]),
                styles: { minCellHeight: 45, verticalAlign: 'middle' },
                columnStyles: { 2: { cellWidth: 60 } },
                didDrawCell: (data) => {
                    if (data.column.index === 2 && data.cell.section === 'body') {
                        const stepId = tableRows[data.row.index][3];
                        const imgData = imageDataStore.get(stepId.toString());
                        if (imgData) {
                            doc.addImage(imgData, 'JPEG', data.cell.x + 2, data.cell.y + 2, 56, 40);
                        }
                    }
                }
            });

            doc.save(`LOTO-${currentID}.pdf`);
        }

        // Initialize
        window.onload = () => { updateID(); addNewPoint(); };
    </script>
</body>
</html>
