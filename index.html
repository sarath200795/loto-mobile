<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOTO Pro - Enterprise Edition</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#b91c1c">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; padding-bottom: 140px; background-color: #f8fafc; }
        .label-style { font-size: 11px; font-weight: 800; color: #1e293b; text-transform: uppercase; margin-bottom: 6px; display: block; }
        .multi-device-scroll { max-height: 250px; overflow-y: auto; border: 2px solid #cbd5e1; padding: 12px; border-radius: 12px; background: #ffffff; }
        .sticky-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 20px; z-index: 1000; display: flex; gap: 12px; box-shadow: 0 -10px 25px rgba(0,0,0,0.1); }
        .step-card { border-left: 8px solid #e2e8f0; border-radius: 16px; background: white; padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .validate.error-border { border-color: #ef4444 !important; background-color: #fef2f2; }
    </style>
</head>
<body>
    <div class="p-4 max-w-lg mx-auto">
        <header class="flex justify-between items-center mb-6 border-b pb-4">
            <h1 class="text-2xl font-black text-slate-900 italic">LOTO<span class="text-red-600">PRO</span></h1>
            <p id="displayID" class="text-xs font-mono font-bold text-red-600 bg-red-50 px-2 py-1 rounded">PENDING</p>
        </header>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 mb-8 space-y-4 shadow-sm">
            <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">General Information</h2>
            <div><label class="label-style">Facility</label><input type="text" id="facility" oninput="updateID()" class="w-full border-2 p-3 rounded-xl validate" placeholder="PLANT-NORTH"></div>
            <div><label class="label-style">Equipment</label><input type="text" id="description" oninput="updateID()" class="w-full border-2 p-3 rounded-xl validate" placeholder="AIR COMPRESSOR"></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="label-style">Location</label><input type="text" id="location" oninput="updateID()" class="w-full border-2 p-3 rounded-xl validate"></div>
                <div><label class="label-style">Date</label><input type="date" id="revisedDate" class="w-full border-2 p-3 rounded-xl validate"></div>
            </div>
        </div>

        <div id="points-list" class="space-y-6"></div>
    </div>

    <div class="sticky-bottom">
        <button onclick="addNewPoint()" class="flex-1 bg-slate-900 text-white font-black py-4 rounded-2xl shadow-lg">+ ADD STEP</button>
        <button onclick="validateAndGenerate()" class="flex-1 bg-red-600 text-white font-black py-4 rounded-2xl shadow-lg italic">GENERATE PDF</button>
    </div>

    <script>
        let uniqueIdCounter = 0;
        let imageDataStore = {}; 
        let currentID = "";

        const energyConfig = {
            "Electrical": { code: "E", bg: [185, 28, 28], text: [255, 255, 255] },
            "Mechanical": { code: "M", bg: [30, 64, 175], text: [255, 255, 255] },
            "Compressed Air": { code: "CA", bg: [8, 145, 178], text: [255, 255, 255] },
            "Hydraulic": { code: "H", bg: [194, 65, 12], text: [255, 255, 255] },
            "Pneumatic": { code: "P", bg: [147, 51, 234], text: [255, 255, 255] },
            "Steam": { code: "S", bg: [71, 85, 105], text: [255, 255, 255] },
            "Water": { code: "W", bg: [14, 165, 233], text: [255, 255, 255] },
            "Radiation": { code: "R", bg: [234, 179, 8], text: [0, 0, 0] }
        };

        const deviceOptions = [
            "Padlock (Personal)", "Lockout Hasp", "Single-Pole Breaker Lock", "Multi-Pole Breaker Lock",
            "480V Breaker Lockout", "Wall Switch Lockout", "Plug Lockout Box", "Ball Valve Lockout (S)",
            "Ball Valve Lockout (L)", "Gate Valve Lockout", "Butterfly Valve Lockout", "Cable Lockout (5ft)",
            "Cable Lockout (10ft)", "Pneumatic Disconnect", "Cylinder Tank Lockout", "E-Stop Cover", "Group Box"
        ];

        function updateID() {
            const fac = document.getElementById('facility').value.trim().toUpperCase() || "FAC";
            const desc = document.getElementById('description').value.trim().toUpperCase() || "DESC";
            currentID = `${fac}-${desc.substring(0,6)}`;
            document.getElementById('displayID').innerText = currentID;
        }

        function reindexAllSteps() {
            const steps = document.querySelectorAll('.step-card');
            const typeCounts = {};
            steps.forEach((card, index) => {
                const id = card.dataset.internalId;
                card.querySelector('.font-black').innerText = `STEP #${index + 1}`;
                const type = document.getElementById(`energy-type-${id}`).value;
                if (type) {
                    const code = energyConfig[type].code;
                    typeCounts[code] = (typeCounts[code] || 0) + 1;
                    document.getElementById(`tag-${id}`).value = `${code}-${typeCounts[code]}`;
                    card.style.borderLeftColor = `rgb(${energyConfig[type].bg.join(',')})`;
                }
            });
        }

        function addNewPoint() {
            uniqueIdCounter++;
            const id = uniqueIdCounter;
            const card = document.createElement('div');
            card.id = `step-container-${id}`;
            card.dataset.internalId = id;
            card.className = "step-card mb-4";
            card.innerHTML = `
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <span class="font-black text-slate-800 uppercase italic">POINT #${id}</span>
                    <input type="text" id="tag-${id}" class="text-right font-mono font-bold text-red-600 bg-transparent w-16" readonly>
                </div>
                <div class="space-y-4">
                    <select id="energy-type-${id}" onchange="reindexAllSteps()" class="w-full border-2 p-3 rounded-xl validate">
                        <option value="">-- Select Energy Source --</option>
                        ${Object.keys(energyConfig).map(k => `<option value="${k}">${k}</option>`).join('')}
                    </select>
                    <div class="multi-device-scroll">
                        ${deviceOptions.map(o => `<label class="flex items-center mb-2"><input type="checkbox" class="device-checkbox-${id} mr-2"> <span class="text-xs font-bold text-slate-600">${o}</span></label>`).join('')}
                    </div>
                    <textarea id="isolate-${id}" class="w-full border-2 p-3 rounded-xl validate" rows="2" placeholder="Describe Isolation Action"></textarea>
                    <textarea id="verify-${id}" class="w-full border-2 p-3 rounded-xl validate" rows="2" placeholder="Verification Method"></textarea>
                    <div class="bg-slate-50 border-2 border-dashed border-slate-300 rounded-2xl p-6 text-center" onclick="document.getElementById('file-${id}').click()">
                        <span class="text-red-600 font-black text-xs uppercase italic">ðŸ“¸ Capture Site Photo</span>
                        <input type="file" id="file-${id}" accept="image/*" capture="environment" onchange="processImage(this, ${id})" class="hidden">
                        <div id="preview-box-${id}" class="mt-3 hidden shadow-md rounded-xl overflow-hidden border-4 border-white"><img id="img-target-${id}" class="w-full h-48 object-cover"></div>
                    </div>
                </div>`;
            document.getElementById('points-list').appendChild(card);
            reindexAllSteps();
        }

        function processImage(input, id) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const compressed = canvas.toDataURL('image/jpeg', 0.7);
                        imageDataStore[id] = compressed;
                        document.getElementById(`img-target-${id}`).src = compressed;
                        document.getElementById(`preview-box-${id}`).classList.remove('hidden');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const qr = new QRious({ value: currentID, size: 250 });
            const steps = document.querySelectorAll('.step-card');

            // --- ENERGY COUNT LOGIC ---
            const counts = {};
            steps.forEach(card => {
                const id = card.dataset.internalId;
                const type = document.getElementById(`energy-type-${id}`).value;
                if (type) counts[type] = (counts[type] || 0) + 1;
            });
            const energySummary = Object.entries(counts).map(([t, c]) => `${t}-${c.toString().padStart(2, '0')}`).join(', ');

            // --- PAGE 1: HEADER & COMPLIANCE ---
            doc.setFillColor(30, 41, 59); doc.rect(0, 0, 210, 20, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(14); doc.text("LOTO INDUSTRIAL PROCEDURE", 10, 13);
            doc.addImage(qr.toDataURL(), 'PNG', 170, 2, 16, 16);

            doc.setDrawColor(0); doc.setLineWidth(0.4); doc.rect(10, 25, 190, 36, 'D');
            doc.setTextColor(0); doc.setFontSize(8); doc.setFont("helvetica", "bold");
            doc.text(`ID#: ${currentID}`, 14, 32);
            doc.text(`FACILITY: ${document.getElementById('facility').value}`, 14, 39);
            doc.text(`EQUIPMENT: ${document.getElementById('description').value}`, 14, 46);
            doc.text(`DATE: ${document.getElementById('revisedDate').value}`, 14, 53);
            
            doc.text(`TOTAL SOURCES: ${steps.length}`, 120, 32);
            const wrappedSummary = doc.splitTextToSize(`SUMMARY: ${energySummary}`, 70);
            doc.text(wrappedSummary, 120, 39);

            // Compliance Box
            doc.rect(10, 65, 190, 50);
            doc.setFontSize(7.5); doc.text("PURPOSE & SCOPE", 14, 72);
            doc.setFont("helvetica", "normal");
            doc.text("1. Purpose: Establish mandatory requirements for isolating hazardous energy whenever maintenance is performed.", 14, 78);
            doc.text("2. Scope: Applies to all employees performing service where unexpected startup could occur.", 14, 84);
            doc.text("3. Authorization: Only 'Authorized' personnel may perform this specific procedure.", 14, 90);
            doc.text("4. Application: 1. Notify 2. Identify 3. Stop 4. Isolate 5. Lock/Tag 6. Release Stored Energy 7. Verify.", 14, 96);

            // TABLE PAGE 1
            const tableBody = [];
            steps.forEach(card => {
                const id = card.dataset.internalId;
                const devs = Array.from(document.querySelectorAll(`.device-checkbox-${id}:checked`)).map(c => c.parentElement.innerText.trim()).join(', ');
                tableBody.push([document.getElementById(`tag-${id}`).value, devs, document.getElementById(`isolate-${id}`).value, "", document.getElementById(`verify-${id}`).value, id]);
            });

            doc.autoTable({
                startY: 125, head: [['TAG', 'DEVICES', 'METHOD', 'VISUAL', 'VERIFY']], body: tableBody.map(r => r.slice(0, 5)),
                theme: 'grid', styles: { minCellHeight: 45, verticalAlign: 'middle', fontSize: 7, lineWidth: 0.2 },
                columnStyles: { 3: { cellWidth: 55 } },
                didDrawCell: (d) => {
                    if (d.column.index === 0 && d.cell.section === 'body') {
                        const sid = tableBody[d.row.index][5];
                        const type = document.getElementById(`energy-type-${sid}`).value;
                        if(energyConfig[type]) {
                            doc.setFillColor(...energyConfig[type].bg); doc.rect(d.cell.x+1, d.cell.y+1, d.cell.width-2, d.cell.height-2, 'F');
                            doc.setTextColor(255,255,255); doc.text(d.cell.text, d.cell.x+d.cell.width/2, d.cell.y+d.cell.height/2, {align:'center', baseline:'middle'});
                        }
                    }
                    if (d.column.index === 3 && d.cell.section === 'body') {
                        const sid = tableBody[d.row.index][5];
                        if (imageDataStore[sid]) doc.addImage(imageDataStore[sid], 'JPEG', d.cell.x+2, d.cell.y+2, 51, 41);
                    }
                }
            });

            // --- PAGE 2: SAFETY SEQUENCES ---
            doc.addPage();
            doc.setFillColor(30, 41, 59); doc.rect(0, 0, 210, 20, 'F');
            doc.setTextColor(255, 255, 255); doc.text("SHUTDOWN & RESTORATION GUIDELINES", 105, 13, { align: "center" });
            
            doc.autoTable({
                startY: 25, head: [['#','SHUTDOWN SEQUENCE','ACTION DESCRIPTION']],
                body:[['1','Notify','Inform all affected associates.'],['2','Identify','Locate all energy sources.'],['3','Stop','Standard stopping procedure.'],['4','Isolate','Operate disconnects/valves.'],['5','Lockout','Apply individual locks/tags.'],['6','Release','Relieve stored pressure/energy.'],['7','Verify','Attempt restart, then OFF.']],
                theme:'grid', headStyles:{fillColor:[185,28,28]}, styles:{fontSize: 8.5}
            });

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 10, head: [['#','RESTORATION SEQUENCE','ACTION DESCRIPTION']],
                body:[['1','Inspect','Remove tools/parts and clear area.'],['2','Area','Ensure all personnel are safely clear.'],['3','Verify','Ensure controls are in Neutral/OFF.'],['4','Restore','Remove all locks and tags personally.'],['5','Notify','Advise work is complete.']],
                theme:'grid', headStyles:{fillColor:[30, 64, 175]}, styles:{fontSize: 8.5}
            });

            doc.save(`${currentID}_FINAL.pdf`);
        }

        function validateAndGenerate() {
            let ok = true;
            document.querySelectorAll('.validate').forEach(el => {
                if (!el.value.trim()) { el.classList.add('error-border'); ok = false; }
                else { el.classList.remove('error-border'); }
            });
            if (ok) generatePDF(); else alert("Incomplete form.");
        }

        window.onload = () => { addNewPoint(); updateID(); };
    </script>
</body>
</html>
