<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOTO Pro - Compliance v4.1</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#b91c1c">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; padding-bottom: 140px; background-color: #f8fafc; }
        .label-style { font-size: 11px; font-weight: 800; color: #1e293b; text-transform: uppercase; margin-bottom: 6px; display: block; }
        .multi-device-scroll { max-height: 280px; overflow-y: auto; border: 2px solid #cbd5e1; padding: 14px; border-radius: 12px; background: #ffffff; }
        .sticky-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 20px; z-index: 1000; display: flex; gap: 12px; box-shadow: 0 -10px 25px rgba(0,0,0,0.1); }
        .step-card { border-left: 8px solid #e2e8f0; border-radius: 16px; background: white; padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    </style>
</head>
<body>
    <div class="p-4 max-w-lg mx-auto">
        <header class="flex justify-between items-center mb-6 border-b pb-4">
            <h1 class="text-2xl font-black text-slate-900 italic">LOTO<span class="text-red-600">PRO</span></h1>
            <p id="displayID" class="text-xs font-mono font-bold text-red-600 bg-red-50 px-2 py-1 rounded">PENDING</p>
        </header>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 mb-8 space-y-4 shadow-sm">
            <div><label class="label-style">Facility</label><input type="text" id="facility" oninput="updateID()" class="w-full border-2 p-3 rounded-xl"></div>
            <div><label class="label-style">Location</label><input type="text" id="location" oninput="updateID()" class="w-full border-2 p-3 rounded-xl"></div>
            <div><label class="label-style">Equipment</label><input type="text" id="description" oninput="updateID()" class="w-full border-2 p-3 rounded-xl"></div>
            <div><label class="label-style">Date</label><input type="date" id="revisedDate" class="w-full border-2 p-3 rounded-xl"></div>
        </div>

        <div id="points-list" class="space-y-6"></div>
    </div>

    <div class="sticky-bottom">
        <button onclick="addNewPoint()" class="flex-1 bg-slate-900 text-white font-black py-4 rounded-2xl shadow-lg">+ STEP</button>
        <button onclick="validateAndGenerate()" class="flex-1 bg-red-600 text-white font-black py-4 rounded-2xl shadow-lg italic">GENERATE</button>
    </div>

    <script>
        let uniqueIdCounter = 0;
        let imageDataStore = {}; 
        let currentID = "";

        const energyConfig = {
            "Electrical":     { code: "E",  bg: [185, 28, 28],  text: [255, 255, 255] },
            "Mechanical":     { code: "M",  bg: [30, 64, 175],  text: [255, 255, 255] },
            "Pneumatic":      { code: "P",  bg: [147, 51, 234], text: [255, 255, 255] },
            "Hydraulic":      { code: "H",  bg: [194, 65, 12],  text: [255, 255, 255] },
            "Compressed Air": { code: "CA", bg: [8, 145, 178],  text: [255, 255, 255] },
            "Steam":          { code: "S",  bg: [71, 85, 105],  text: [255, 255, 255] },
            "Water":          { code: "W",  bg: [14, 165, 233], text: [255, 255, 255] },
            "Chemical":       { code: "C",  bg: [21, 128, 61],  text: [255, 255, 255] },
            "Radiation":      { code: "R",  bg: [234, 179, 8],  text: [0, 0, 0] },
            "Thermal":        { code: "T",  bg: [249, 115, 22], text: [255, 255, 255] }
        };

        const deviceOptions = [
            "Assigned Safety Padlock", "Steel Hasp (1\")", "Steel Hasp (1.5\")", "Non-Conductive Hasp",
            "Single-Pole Breaker Lockout", "Multi-Pole Breaker Lockout", "480V Breaker Lockout",
            "Wall Switch Lockout", "Electrical Plug Lockout", "Ball Valve Lockout (S)",
            "Ball Valve Lockout (L)", "Butterfly Valve Lockout", "Rotating Gate Valve Cover",
            "Plug Valve Lockout", "Cable Lockout (Adjustable)", "Pneumatic Disconnect Lockout",
            "Cylinder Tank Lockout", "Blind Flange Lockout", "Group Lock Box", "Safety Tagout Tag"
        ];

        function updateID() {
            const fac = (document.getElementById('facility').value || "FAC").substring(0,3).toUpperCase();
            const loc = (document.getElementById('location').value || "LOC").substring(0,3).toUpperCase();
            const desc = (document.getElementById('description').value || "DESC").substring(0,5).toUpperCase();
            currentID = `${fac}-${loc}-${desc}`;
            document.getElementById('displayID').innerText = currentID;
        }

        function reindexAllSteps() {
            const steps = document.querySelectorAll('.step-card');
            const typeCounts = {};
            steps.forEach((card, index) => {
                const id = card.dataset.internalId;
                card.querySelector('.font-black').innerText = `STEP #${index + 1}`;
                const type = document.getElementById(`energy-type-${id}`).value;
                if (type) {
                    const code = energyConfig[type].code;
                    typeCounts[code] = (typeCounts[code] || 0) + 1;
                    document.getElementById(`tag-${id}`).value = `${code}-${typeCounts[code]}`;
                    card.style.borderLeftColor = `rgb(${energyConfig[type].bg.join(',')})`;
                }
            });
        }

        function addNewPoint() {
            uniqueIdCounter++;
            const id = uniqueIdCounter;
            const container = document.getElementById('points-list');
            const card = document.createElement('div');
            card.id = `step-container-${id}`;
            card.dataset.internalId = id;
            card.className = "step-card mb-4";
            card.innerHTML = `
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <span class="font-black text-slate-800 italic uppercase">POINT #${id}</span>
                    <div class="flex items-center gap-2">
                        <input type="text" id="tag-${id}" class="text-right font-mono font-bold text-red-600 bg-red-50 p-1 w-16 rounded" readonly>
                        <button onclick="document.getElementById('step-container-${id}').remove();reindexAllSteps();" class="text-slate-300 hover:text-red-600">âœ•</button>
                    </div>
                </div>
                <div class="space-y-4">
                    <select id="energy-type-${id}" onchange="reindexAllSteps()" class="w-full border-2 p-3 rounded-xl font-bold">
                        <option value="">-- Energy Source Type --</option>
                        ${Object.keys(energyConfig).map(k => `<option value="${k}">${k}</option>`).join('')}
                    </select>
                    <label class="label-style">LOTO Hardware Selection</label>
                    <div class="multi-device-scroll">
                        ${deviceOptions.map(o => `<label class="flex items-center mb-3"><input type="checkbox" class="device-checkbox-${id} w-5 h-5 text-red-600 mr-3 border-2 border-slate-300 rounded"> <span class="text-xs font-bold text-slate-600">${o}</span></label>`).join('')}
                    </div>
                    <textarea id="isolate-${id}" class="w-full border-2 p-3 rounded-xl text-sm" rows="2" placeholder="Isolation Method"></textarea>
                    <textarea id="verify-${id}" class="w-full border-2 p-3 rounded-xl text-sm" rows="2" placeholder="Verification Method"></textarea>
                    <div class="bg-slate-50 border-2 border-dashed border-slate-300 rounded-2xl p-6 text-center cursor-pointer" onclick="document.getElementById('file-${id}').click()">
                        <span class="text-red-600 font-black text-xs uppercase italic">ðŸ“¸ Capture Site Photo</span>
                        <input type="file" id="file-${id}" accept="image/*" capture="environment" onchange="processImage(this, ${id})" class="hidden">
                        <div id="preview-box-${id}" class="mt-3 hidden shadow-md rounded-xl overflow-hidden border-4 border-white"><img id="img-target-${id}" class="w-full h-48 object-cover"></div>
                    </div>
                </div>`;
            container.appendChild(card);
            reindexAllSteps();
        }

        function processImage(input, id) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        imageDataStore[id] = canvas.toDataURL('image/jpeg', 0.7);
                        document.getElementById(`img-target-${id}`).src = imageDataStore[id];
                        document.getElementById(`preview-box-${id}`).classList.remove('hidden');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const qr = new QRious({ value: currentID, size: 250 });
            const steps = document.querySelectorAll('.step-card');

            // --- ENERGY ANALYTICS ENGINE ---
            const counts = {};
            steps.forEach(card => {
                const id = card.dataset.internalId;
                const type = document.getElementById(`energy-type-${id}`).value;
                if (type) counts[type] = (counts[type] || 0) + 1;
            });
            const energySummary = Object.entries(counts).map(([t, c]) => `${t}-${c.toString().padStart(2, '0')}`).join(', ');

            // --- PAGE 1: HEADER & TABLE ---
            doc.setFillColor(30, 41, 59); doc.rect(0, 0, 210, 22, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(14); doc.text("LOTO INDUSTRIAL PROCEDURE", 10, 13);
            doc.addImage(qr.toDataURL(), 'PNG', 170, 2, 16, 16);

            doc.setDrawColor(0); doc.setLineWidth(0.4); doc.rect(10, 28, 190, 42, 'D');
            doc.setTextColor(0); doc.setFontSize(8); doc.setFont("helvetica", "bold");
            doc.text(`ID#: ${currentID}`, 14, 34);
            doc.text(`FACILITY: ${document.getElementById('facility').value}`, 14, 40);
            doc.text(`LOCATION: ${document.getElementById('location').value}`, 14, 46);
            doc.text(`EQUIPMENT: ${document.getElementById('description').value}`, 14, 52);
            doc.text(`DATE: ${document.getElementById('revisedDate').value}`, 14, 58);
            
            doc.text(`TOTAL SOURCES: ${steps.length}`, 115, 34);
            const wrappedSummary = doc.splitTextToSize(`SUMMARY: ${energySummary}`, 75);
            doc.text(wrappedSummary, 115, 40);

            const tableData = [];
            steps.forEach(card => {
                const id = card.dataset.internalId;
                const devs = Array.from(document.querySelectorAll(`.device-checkbox-${id}:checked`)).map(c => c.parentElement.innerText.trim()).join(', ');
                tableBody.push([document.getElementById(`tag-${id}`).value, devs, document.getElementById(`isolate-${id}`).value, "", document.getElementById(`verify-${id}`).value, id]);
            });

            doc.autoTable({
                startY: 85, head: [['TAG', 'HARDWARE', 'METHOD', 'VISUAL', 'VERIFY']], body: tableData.map(r => r.slice(0, 5)),
                theme: 'grid', styles: { minCellHeight: 45, verticalAlign: 'middle', fontSize: 7, lineWidth: 0.2 },
                columnStyles: { 0: {cellWidth: 15, fontStyle: 'bold', halign: 'center'}, 3: {cellWidth: 55} },
                didDrawCell: (d) => {
                    if (d.column.index === 0 && d.cell.section === 'body') {
                        const sid = tableData[d.row.index][5];
                        const type = document.getElementById(`energy-type-${sid}`).value;
                        if(energyConfig[type]) {
                            doc.setFillColor(...energyConfig[type].bg); doc.rect(d.cell.x+1, d.cell.y+1, d.cell.width-2, d.cell.height-2, 'F');
                            doc.setTextColor(255,255,255); doc.text(d.cell.text, d.cell.x+d.cell.width/2, d.cell.y+d.cell.height/2, {align:'center', baseline:'middle'});
                        }
                    }
                    if (d.column.index === 3 && d.cell.section === 'body') {
                        const sid = tableData[d.row.index][5];
                        if (imageDataStore[sid]) doc.addImage(imageDataStore[sid], 'JPEG', d.cell.x+2, d.cell.y+2, 51, 41);
                    }
                }
            });

            // --- PAGE 2: SEQUENCES ---
            doc.addPage();
            doc.autoTable({ startY: 20, head: [['SHUTDOWN SEQUENCE', 'ACTION']], body: [['1. Notify','Inform affected employees.'],['2. Review','Identify energy sources.'],['3. Stop','Standard shutdown.'],['4. Isolate','Operate disconnects.'],['5. Lock/Tag','Apply locks.'],['6. Release','Dissipate energy.'],['7. Verify','Test restart.'],], theme:'grid', headStyles:{fillColor:[185,28,28]} });
            doc.autoTable({ startY: doc.lastAutoTable.finalY + 10, head: [['RESTORATION SEQUENCE', 'ACTION']], body: [['1. Inspect','Clear area and check tools.'],['2. Area','Confirm all personnel clear.'],['3. Reset','Ensure controls neutral.'],['4. Unlock','Remove all locks/tags.'],['5. Notify','Advise work is complete.']], theme:'grid', headStyles:{fillColor:[30, 64, 175]} });

            // --- PAGE 3: TAGS ---
            doc.addPage();
            doc.text("ISOLATION POINT TAGS (1\" x 2\")", 10, 15);
            let cx = 15, cy = 25;
            tableData.forEach(row => {
                const sid = row[5];
                const type = document.getElementById(`energy-type-${sid}`).value;
                const c = energyConfig[type] || {bg:[255,255,255], text:[0,0,0]};
                doc.setFillColor(...c.bg); doc.rect(cx, cy, 50, 25, 'F');
                doc.setTextColor(255,255,255); doc.setFontSize(18); doc.text(row[0], cx+4, cy+10);
                doc.addImage(qr.toDataURL(), 'PNG', cx + 33, cy + 3, 14, 14);
                cx += 55; if (cx > 160) { cx = 15; cy += 30; }
            });

            doc.save(`${currentID}_FINAL.pdf`);
        }

        function validateAndGenerate() { generatePDF(); }
        window.onload = () => { addNewPoint(); updateID(); };
    </script>
</body>
</html>
